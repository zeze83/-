---
title: "Data cleaning and EDA"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("table1")
install.packages("cowplot")
library(tidyverse)
library(readr)
library(ggplot2)
library(table1)
library(cowplot)
```


## Data Description: 

The dataset was collected by the Behavioral Risk Factor Surveillance System (BRFSS) in 2015. This original dataset contains responses from 441,455 individuals and has 330 features. For this project, we use the one with 253,680 responses and a three-class diabetes target variable indicating no diabetes, prediabetes, or diabetes. The potential factors for diabetes are biological factors such as sex, blood pressure, cholesterol, BMI, heart disease, social factors such as education and income, and habits of smoking, physical exercise, eating fruit and vegetables.

There are 22 variables in our original dataset.

* `Diabetes_012`: This is a categorical variable indicating the diabetes condition of the individual. 0 is for no diabetes or only during pregnancy, 1 is for prediabetes, and 2 is for diabetes.

* `HighBP`: This is a categorical variable indicating whether or not an individual has high blood pressure. (0 = no, 1 = yes)

* `HighChol`: This is a categorical variable indicating whether or not an individual has high blood cholesterol. (0 = no, 1 = yes)

 * `Cholcheck`: This is a categorical variable indicating whether or not an individual has cholesterol check in 5 years. (0 = no, 1 = yes)
 
* `BMI`: It is a continuous variable indicating individual's Body Mass Index.

* `Smoker`: It is a categorical variable showing participants identify themselves whether they have smoked at least 100 cigarettes in their entire life. (0 = no, 1 = yes)

* `Stroke`: A categorical variable indicating whether the individual was told they had a stroke. (0 = no, 1 = yes)

* `HeartDiseaseorAttack`: A categorical variable showing whether the individual had coronary heart disease (CHD) or myocardial infarction (MI). (0 = no, 1 = yes)

* `PhysActivity`: A categorical variable showing whether individual has physical activity in past 30 days which are not included in job. (0 = no, 1 = yes)

* `Fruits`: A categorical variable showing whether the individual consumes fruit 1 or more times per day. (0 = no, 1 = yes)

* `Veggies`: A categorical variable showing whether the individual consumes vegetables 1 or more times per day. (0 = no, 1 = yes)

* `HvyAlcoholConsump`: A categorical variable showing whether the individual is a heavy drinker, which means adult men having more than 14 drinks per week and adult women having more than 7 drinks per week. (0 = no, 1 = yes)

* `AnyHealthcare`: A categorical variable showing whether the individual has any kind of health care coverage, including health insurance, prepaid plans such as HMO, etc. (0 = no, 1 = yes)

* `NoDocbcCost`: A categorical variable showing whether the individual has a time in the past 12 months when he/she needed to see a doctor but could not because of cost. (0 = no, 1 = yes)

* `GenHlth`: A categorical variable showing the self evaluation of the individual's general health. (1 = excellent, 2 = very good, 3 = good, 4 = fair, 5 = poor)

* `MentHlth`: A categorical variable showing the self evaluation of the individual was showing mental health problems including stress, depression, and problems with emotions, for how many days in their past 30 days.

* `PhysHlth`: A categorical variable showing the self evaluation of the individual was showing physical health problems, which includes physical illness and injury, for how many days during the past 30.

* `DiffWalk`: A categorical variable showing the self evaluation of whether the individual has serious difficulty walking or climbing stairs. (0 = no, 1 = yes)

* `Sex`: A categorical variable showing the individual's born sex. (0 = female, 1 = male)

* `Age`: A categorical variable showing the individual's age. (1 = 18-24 9 = 60-64 13 = 80 or older)

* `Education`: A categorical variable showing the individual's Education level in the scale of 1-6.

* `Income`: A categorical variable showing the individual's income level in the scale of 1-8. (1 = less than 10,000 dollars, 5 = less than 35,000 dollars, 8 = 75,000 dollars or more)

To explore our question of interest, we will keep `Diabetes_012` as our dependent variable, and investigate the relationship between the other variables and `Diabetes_012`. In our hypothesis, biological factors including blood pressure, cholesterol level, BMI, Heart Disease, age, and sex might have a relationship with the levels of diabetes, so we keep variables `HighBP`, `HighChol`, `BMI`, `HeartDiseaseorAttack`, `Age`, and `Sex`. 

We also predict that social factors including income, education, smoking habits, alcohol consumption, physical exercise frequency, and fruit and vegetable eating will be associated with different diabetes levels. Therefore, we want to keep `Income`, `Education`, `Smoker`, `PhysActivity`, `Fruits`, `HvyAlcoholConsump`, and `Veggies` variables.

## Read in and Clean Data  


First, we read in our data from the csv file. 

```{r}
diabetes_raw <- read_csv("data/Diabetes_012_data.csv")

head(diabetes_raw)
```
```{r}
diabetes_raw <- diabetes_raw |>
  select(Diabetes_012,HighBP,HighChol, BMI, Smoker, 
         HeartDiseaseorAttack, Sex,Income, Education, 
         PhysActivity, Fruits, Veggies, Age, HvyAlcoholConsump) |>
   mutate(Diabetes_012 = factor(Diabetes_012, levels = c(0, 1, 2), 
         labels = c("No Diabetes", "Pre-Diabetes", "Diabetes")),
         HighBP = factor(HighBP, levels = c(0, 1), labels = c("No", "Yes")),
         HighChol = factor(HighChol, levels = c(0, 1), labels = c("No", "Yes")),
         HeartDiseaseorAttack = factor(HeartDiseaseorAttack, 
                                       levels = c(0, 1), labels = c("No", "Yes")),
         Sex = factor(Sex, levels = c(0, 1), labels = c("Female", "Male")),
         Fruits = factor(Fruits, levels = c(0, 1), labels = c("No", "Yes")),
         Veggies = factor(Veggies, levels = c(0, 1), labels = c("No", "Yes")),
         HvyAlcoholConsump = factor(HvyAlcoholConsump, levels = c(0, 1), labels = c("No", "Yes")))

diabetes_raw


```


## Exploratory Data Analysis

### Bivariate Plots and Analysis Analysis

We first perform univariate analysis for our dependent variable `Diabetes_012` and plot the bivariate relationship between our interested factors with the diabetes variable respectively. 


#### Distribution of Diabetes Types
```{r}
Diabetesraw_dist = 
  ggplot(diabetes_raw, aes(Diabetes_012)) + 
  geom_bar(aes(fill = Diabetes_012)) +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes Status") +
  ggtitle("Raw Overall Diabetes Status Distribution") +
  theme_minimal()

Diabetesraw_dist
```


From the distribution of Diabetes Status, we realize that Pre-Diabetes status has extreme low data samples, so we will exclude this data in our future analysis.

```{r}
diabetes_new = 
  diabetes_raw |>
  filter(Diabetes_012 == 'Diabetes' | Diabetes_012 == 'No Diabetes') |>
  rename(Diabetes_status = Diabetes_012)

diabetes_new
write.csv(diabetes_new, "data/diabetes_new.csv", row.names = FALSE)
  
```


## Now We are ready to do univariable distribution over diabetes status.

####  1. High Blood Pressure via Diabetes
```{r}
HighBP_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = HighBP), position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes Status") +
  ggtitle("HighBP over Diabetes") +
  theme_minimal()

HighBP_dist
```

####  2. High Cholesterol Level via Diabetes
```{r}
HighChol_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = HighChol), position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes Status") +
  ggtitle("HighChol over Diabetes") +
  theme_minimal()

HighChol_dist
```


####  3. BMI via Diabetes
```{r}
BMI_dist = 
  ggplot(diabetes_new, aes(BMI, ..count..)) + 
  geom_bar(aes(fill = Diabetes_status)) +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("BMI") +
  ggtitle("BMI Distribution") +
  theme_minimal() 

BMI_dist
```



####  4. Heart Disease or Attack via Diabetes
```{r}
Heartdisease_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = HeartDiseaseorAttack), position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes Status") +
  ggtitle("Heart Disease over Diabetes") +
  theme_minimal()

Heartdisease_dist
```

####  5. Age via Diabetes
```{r}
Age_dist = 
  ggplot(diabetes_new, aes(Age, ..count..)) + 
  geom_bar(aes(fill = Diabetes_status)) +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Age") +
  ggtitle("Age Distribution") +
  theme_minimal()

Age_dist
```


####  5. Sex via Diabetes
```{r}
Sex_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = Sex), , position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes") +
  ggtitle("Sex over Diabetes Status") +
  theme_minimal()

Sex_dist
```
####  6. Sex via Diabetes
```{r}
Sex_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = Sex), , position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes") +
  ggtitle("Sex over Diabetes Status") +
  theme_minimal()

Sex_dist
```
####  7. Income via Diabetes
```{r}
Income_dist = 
  ggplot(diabetes_new, aes(Income, ..count..)) + 
  geom_bar(aes(fill = Diabetes_status)) +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Income") +
  ggtitle("Income Distribution") +
  theme_minimal()

Income_dist
```


####  8. Education via Diabetes
```{r}
Education_dist = 
  ggplot(diabetes_new, aes(Education, ..count..)) + 
  geom_bar(aes(fill = Diabetes_status)) +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Education") +
  ggtitle("Education Distribution") +
  theme_minimal()

Education_dist
```


####  9. Fruits via Diabetes
```{r}
Fruits_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = Fruits), , position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes") +
  ggtitle("Fruits over Diabetes") +
  theme_minimal()

Fruits_dist
```
####  10. Veggies via Diabetes
```{r}
Veggies_dist = 
  ggplot(diabetes_new, aes(Diabetes_status, ..count..)) + 
  geom_bar(aes(fill = Veggies), , position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Diabetes") +
  ggtitle("Vegetables over Diabetes") +
  theme_minimal()

Veggies_dist
```

## Plots all together
```{r}
plots1 = plot_grid(
  HighBP_dist + theme(legend.position="none"),
  HighChol_dist + theme(legend.position="none"), 
  Heartdisease_dist + theme(legend.position="none"),
  Fruits_dist + theme(legend.position="none"), 
  Veggies_dist + theme(legend.position="none"),
  Age_dist + theme(legend.position="none"),
  BMI_dist + theme(legend.position="none"),
  Education_dist + theme(legend.position="none"), 
  Income_dist + theme(legend.position="none")) +
  theme(axis.text.x = element_text(size = 5))
plots1

plots2 = plot_grid(
  Age_dist + theme(legend.position="none"), 
  BMI_dist + theme(legend.position="none"), 
  Education_dist + theme(legend.position="none"), 
  Income_dist) +
  theme(axis.text.x = element_text(size = 5))
plots2


```


BMI Categorization

```{r}
# write a function to categorize bmi values to diverse weight status
categorize_bmi <- function(bmi) {
  if (bmi < 18.5) {
    return("Underweight")
  } else if (bmi >= 18.5 & bmi < 25) {
    return("Normal weight")
  } else if (bmi >= 25 & bmi < 30) {
    return("Overweight")
  } else {
    return("Obesity")
  }
}
# add a column named weight_status to the data set
diabetes_raw$weight_status <- sapply(diabetes_raw$BMI, categorize_bmi)

```

#### Plot: Association between Diabetes Status and blood pressure status
```{r}
ggplot(diabetes_raw, aes(x = Diabetes_012, fill = HighBP)) +
  geom_bar(position = "fill") +
  ylab("Blood Pressure Status") +
  xlab("Diabetes Status") +
  ggtitle("Association between Diabetes Status and Blood Pressure Status") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_minimal()
```

#### Plot: Association between Diabetes Status and Weight Status
```{r}
ggplot(diabetes_raw, aes(x = Diabetes_012, fill = weight_status)) +
  geom_bar(position = "fill") +
  ylab("Proportion") +
  xlab("Diabetes Status") +
  ggtitle("Association between Diabetes Status and Weight Status") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_minimal()
```

#### Plot: Box plot distribution of BMI in different Diabetes status
```{r}
plotBMI = ggplot(diabetes_raw, aes(x = BMI, y = Diabetes_012, fill = Diabetes_012))+
        geom_boxplot(alpha = 0.5) +
        theme(legend.position = 'none') +
        scale_fill_brewer(palette = 'Pastel1') +
        ylab("Diabetes Status") +
        xlab("BMI Distribution") +
        ggtitle("Box Plot Distribution of BMI over Diabetes Status") +
        theme_minimal()
        
  
  
plotBMI
```

#### Plot: Smoking Status over Diabetes Status
```{r}
plot_smoke = 
  ggplot(diabetes_raw, aes(Smoker, ..count..)) + 
  geom_bar(aes(fill = Diabetes_012), position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Smoking Status") +
  ggtitle("Smoking Status Frequencies over Diabetes Status") +
  theme_minimal()

plot_smoke
```
### Plot: Fruits or Veggies over different Diabetes Status
```{r}
mosaicplot(Fruits~Veggies,data=diabetes_raw,col=c("Light Pink","Light Blue"))
```



#### Plot: Distribution of Education Level over different Diabetes Status
```{r}
plot_education = 
  ggplot(diabetes_raw, aes(x = Education, ..count..)) + 
  geom_bar(aes(fill = Diabetes_012), position = 'dodge') +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Education Level") +
  ggtitle("Education Level Frequencies over Diabetes Status") +
  theme_minimal()

plot_education
```

#### Plot: Distribution of Income Level over different Diabetes Status
```{r}
plot_income = 
  ggplot(diabetes_raw, aes(Income, ..count..)) + 
  geom_bar(aes(fill = Diabetes_012), position = "dodge") +
  scale_fill_brewer(palette = 'Pastel1') +
  ylab("Frequencies") +
  xlab("Income Level") +
  ggtitle("Income Level Frequencies over Diabetes Status") +
  theme_minimal()

plot_income
```

#### Statistical Test 1.1 P-value function
```{r}
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a one-side anova test
        p <- aov(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
```


#### Create R table 1
```{r}
## Rtable_1 shows the demographics stats
Rtable_1 = 
  table1(~ factor(Sex) + Age| Diabetes_012, data=diabetes_raw, overall=F, extra.col=list(`P-value`=pvalue))

Rtable_1
```


```{r}
## Rtable_2 shows the physiology status factor stats
Rtable_2 = 
  table1(~ factor(HighBP) + factor(HighChol) + BMI + factor(weight_status) | Diabetes_012, data=diabetes_raw, overall=F, extra.col=list(`P-value`=pvalue))

Rtable_2
```


```{r}
## Rtable_3 shows the social-economic factor stats
Rtable_3 = 
  table1(~ factor(Education) + factor(Income) | Diabetes_012, data=diabetes_raw, overall=F, extra.col=list(`P-value`=pvalue))

Rtable_3
```

We don't have any healthcare, so drop here
```{r}
## Rtable_4 shows the physical-habits factor stats
#Rtable_4 = 
#  table1(~ factor(Smoker) + factor(PhysActivity) + factor(Fruits) + factor(Veggies) + factor(HvyAlcoholConsump) + factor(AnyHealthcare) | Diabetes_012, data=diabetes_raw, overall=F, extra.col=list(`P-value`=pvalue))

#Rtable_4
```

No diffwalk, so comment here
```{r}
## Rtable_5 shows the symptoms/disease related stats
#Rtable_5 = 
  #table1(~ factor(Stroke) + factor(HeartDiseaseorAttack) + factor(DiffWalk) | Diabetes_012, data=diabetes_raw, overall=F, extra.col=list(`P-value`=pvalue))

#Rtable_5
```




### Data Random sampling each 500 from both diabetes and nondiabetes population. Join them together.

```{r}
set.seed(123)

diabetes= 
  diabetes_raw |>
  filter(Diabetes_012 == 'Diabetes')
diabetes_sample =
  sample_n(diabetes, size = 500, replace = FALSE)

diabetes_sample

nondiabetes= 
  diabetes_raw |>
  filter(Diabetes_012 == 'No Diabetes')
nondiabetes_sample =
  sample_n(nondiabetes, size = 500, replace = FALSE)

nondiabetes_sample

sample_df = full_join(diabetes_sample, nondiabetes_sample)
sample_df

```

## Covariate visualisation

### 1. HighBP + BMI 
```{r}
ggplot(sample_df, aes(fill=Diabetes_012, y=BMI, x=HighBP)) + 
  geom_bar(position="dodge", stat="identity") +
  ylab("BMI") +
  xlab("Blood Pressure Level") +
  ggtitle("Association between HighBP & BMI") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_minimal()
```


### 1. HighChol + BMI 
```{r}
ggplot(sample_df, aes(fill=Diabetes_012, y=BMI, x=HighChol)) + 
  geom_bar(position="dodge", stat="identity") +
  ylab("BMI") +
  xlab("Cholesterol Level") +
  ggtitle("Association between Cholesterol Level & BMI") +
  scale_fill_brewer(palette = "Pastel1") +
  theme_minimal()
```
### Veggies + Fruits vs Physactivity
```{r}

```


#### High Blood Pressure in Different Diabetes Status

